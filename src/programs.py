from typing import Callable, Dict, List

from controls import DEFAULT_ARM_SPEED, move_to_pose, home_gripper, move_to_home, grasp
from notifier import notify_arm_location, notify_handover_finished


class MoveToHandoverProgram:
    def __init__(self, target_1: tuple, target_2: tuple, speed: float):
      self.target_1 = target_1
      self.target_2 = target_2
      self.speed = speed


class ContainerProgram:
    def __init__(self, container_pose: tuple, rotation_pose: tuple):
      self.container_pose = container_pose
      self.rotation_pose = rotation_pose


left_tray_index = 0
right_tray_index = 0

packaging_containers: List[ContainerProgram] = [
    ContainerProgram(
        [-0.010023348557065725, -1.7079192760032518, 1.6999780956344666, -1.6403701248503568, 0.15241088191079502, 2.8367659405469907, -0.7548797059522734, 0.015098736621439457, 0.015098736621439457],
        [-0.0033192516823805735, -1.6961195568810383, 1.6810605170405049, -1.6311758842802881, 0.280698299659623, 2.8368289743424793, -0.25135923787620335, 0.015098736621439457, 0.015098736621439457]
    ),
    ContainerProgram(
        [-0.03201815732686143, -1.7040221984559962, 1.6941629300579082, -1.7901759392541843, 0.2830293888383441, 2.837107262704107, -0.9460787956383493, 0.015098736621439457, 0.015098736621439457],
        [-0.03217737962673798, -1.6995354017793085, 1.7005778149889224, -1.79213025795786, 0.2845354160277524, 2.8370995443179186, -0.20318402414189446, 0.015098736621439457, 0.015098736621439457]
    ),
    ContainerProgram(
        [-0.1604143112918787, -1.700683772905683, 1.6941169197015098, -1.8542605280771645, 0.2842621836966266, 2.8376643706295224, -0.9449058851069874, 0.015098736621439457, 0.015098736621439457],
        [-0.1625585885966478, -1.699506622732732, 1.6915988883693316, -1.854547183388158, 0.28533237124813926, 2.8376658965084287, -0.18449669544564354, 0.015098736621439457, 0.015098736621439457]
    ),
    ContainerProgram(
        [-0.35687022110035543, -1.7323485348429901, 1.6545607295771136, -1.8012316790798255, 0.2839151480330361, 2.837644981577617, -0.9331039174861377, 0.015098736621439457, 0.015098736621439457],
        [-0.3656508367438065, -1.7319905478294069, 1.6516638260891563, -1.800578189565424, 0.28823308206512743, 2.837632927502794, -0.08346200291977988, 0.015098736621439457, 0.015098736621439457]
    ),
    ContainerProgram(
        [-0.6469529692290898, -1.7514654362735431, 1.6342895437876384, -1.6461642797369707, 0.28347464222483915, 2.8385737054480447, -0.8861830274727608, 0.015098736621439457, 0.015098736621439457],
        [-0.6469568364160103, -1.7513874364652149, 1.6391983439127604, -1.6433231790442213, 0.2945183922254899, 2.8385839542680316, -0.05900522629088825, 0.015098736621439457, 0.015098736621439457]
    ),
]
current_container_index = 0
number_of_items_in_container = 0


left_tray_handovers: List[MoveToHandoverProgram] = [
    MoveToHandoverProgram(
        [-1.9553351520631692, -1.7289233916600544, 1.764272976147765, -2.25836604827747, 0.15970306820339625, 3.5636313774663098, -0.781281786011325, 0.039349764585494995, 0.039349764585494995],
        [-2.3174051406017306, -1.7464846269616918, 1.7174293490793224, -1.8560868397825845, 0.19099589394198524, 3.5632729483577936, -0.8292145864632393, 0.03934943675994873, 0.03934943675994873],
        DEFAULT_ARM_SPEED
    ),
    MoveToHandoverProgram(
        [-1.9553351520631692, -1.7289233916600544, 1.764272976147765, -2.25836604827747, 0.15970306820339625, 3.5636313774663098, -0.781281786011325, 0.039349764585494995, 0.039349764585494995],
        [-2.3174051406017306, -1.7464846269616918, 1.7174293490793224, -1.8560868397825845, 0.19099589394198524, 3.5632729483577936, -0.8292145864632393, 0.03934943675994873, 0.03934943675994873],
        DEFAULT_ARM_SPEED
    ),
    MoveToHandoverProgram(
        [-1.9553351520631692, -1.7289233916600544, 1.764272976147765, -2.25836604827747, 0.15970306820339625, 3.5636313774663098, -0.781281786011325, 0.039349764585494995, 0.039349764585494995],
        [-2.3174051406017306, -1.7464846269616918, 1.7174293490793224, -1.8560868397825845, 0.19099589394198524, 3.5632729483577936, -0.8292145864632393, 0.03934943675994873, 0.03934943675994873],
        DEFAULT_ARM_SPEED
    ),
    MoveToHandoverProgram(
        [-1.9553351520631692, -1.7289233916600544, 1.764272976147765, -2.25836604827747, 0.15970306820339625, 3.5636313774663098, -0.781281786011325, 0.039349764585494995, 0.039349764585494995],
        [-2.3174051406017306, -1.7464846269616918, 1.7174293490793224, -1.8560868397825845, 0.19099589394198524, 3.5632729483577936, -0.8292145864632393, 0.03934943675994873, 0.03934943675994873],
        DEFAULT_ARM_SPEED
    ),
    MoveToHandoverProgram(
        [-1.9553351520631692, -1.7289233916600544, 1.764272976147765, -2.25836604827747, 0.15970306820339625, 3.5636313774663098, -0.781281786011325, 0.039349764585494995, 0.039349764585494995],
        [-2.3174051406017306, -1.7464846269616918, 1.7174293490793224, -1.8560868397825845, 0.19099589394198524, 3.5632729483577936, -0.8292145864632393, 0.03934943675994873, 0.03934943675994873],
        DEFAULT_ARM_SPEED
    ),
    MoveToHandoverProgram(
        [-1.9553351520631692, -1.7289233916600544, 1.764272976147765, -2.25836604827747, 0.15970306820339625, 3.5636313774663098, -0.781281786011325, 0.039349764585494995, 0.039349764585494995],
        [-2.3174051406017306, -1.7464846269616918, 1.7174293490793224, -1.8560868397825845, 0.19099589394198524, 3.5632729483577936, -0.8292145864632393, 0.03934943675994873, 0.03934943675994873],
        DEFAULT_ARM_SPEED
    ),
    MoveToHandoverProgram(
        [-1.9553351520631692, -1.7289233916600544, 1.764272976147765, -2.25836604827747, 0.15970306820339625, 3.5636313774663098, -0.781281786011325, 0.039349764585494995, 0.039349764585494995],
        [-2.3174051406017306, -1.7464846269616918, 1.7174293490793224, -1.8560868397825845, 0.19099589394198524, 3.5632729483577936, -0.8292145864632393, 0.03934943675994873, 0.03934943675994873],
        DEFAULT_ARM_SPEED
    ),
    MoveToHandoverProgram(
        [-1.9553351520631692, -1.7289233916600544, 1.764272976147765, -2.25836604827747, 0.15970306820339625, 3.5636313774663098, -0.781281786011325, 0.039349764585494995, 0.039349764585494995],
        [-2.3174051406017306, -1.7464846269616918, 1.7174293490793224, -1.8560868397825845, 0.19099589394198524, 3.5632729483577936, -0.8292145864632393, 0.03934943675994873, 0.03934943675994873],
        DEFAULT_ARM_SPEED
    ),
    MoveToHandoverProgram(
        [-1.9553351520631692, -1.7289233916600544, 1.764272976147765, -2.25836604827747, 0.15970306820339625, 3.5636313774663098, -0.781281786011325, 0.039349764585494995, 0.039349764585494995],
        [-2.3174051406017306, -1.7464846269616918, 1.7174293490793224, -1.8560868397825845, 0.19099589394198524, 3.5632729483577936, -0.8292145864632393, 0.03934943675994873, 0.03934943675994873],
        DEFAULT_ARM_SPEED
    ),
    MoveToHandoverProgram(
        [-1.9553351520631692, -1.7289233916600544, 1.764272976147765, -2.25836604827747, 0.15970306820339625, 3.5636313774663098, -0.781281786011325, 0.039349764585494995, 0.039349764585494995],
        [-2.3174051406017306, -1.7464846269616918, 1.7174293490793224, -1.8560868397825845, 0.19099589394198524, 3.5632729483577936, -0.8292145864632393, 0.03934943675994873, 0.03934943675994873],
        DEFAULT_ARM_SPEED
    ),
]
right_tray_handovers: List[MoveToHandoverProgram] = [
    MoveToHandoverProgram(
        [-1.5547487497664334, -1.7548655496061893, 1.8098866582403617, -2.195141738907591, 0.19108510024017758, 3.6259514539374242, -0.7562993065979746, 0.03935009241104126, 0.03935009241104126],
        [-1.979525540786877, -1.7568802659049967, 1.7494914613459918, -1.6939346870251333, 0.1910150717364417, 3.625722295510163, -0.8387378708985116, 0.03934943675994873, 0.03934943675994873],
        DEFAULT_ARM_SPEED
    ),
    MoveToHandoverProgram(
        [-1.5547487497664334, -1.7548655496061893, 1.8098866582403617, -2.195141738907591, 0.19108510024017758, 3.6259514539374242, -0.7562993065979746, 0.03935009241104126, 0.03935009241104126],
        [-1.979525540786877, -1.7568802659049967, 1.7494914613459918, -1.6939346870251333, 0.1910150717364417, 3.625722295510163, -0.8387378708985116, 0.03934943675994873, 0.03934943675994873],
        DEFAULT_ARM_SPEED
    ),
    MoveToHandoverProgram(
        [-1.5547487497664334, -1.7548655496061893, 1.8098866582403617, -2.195141738907591, 0.19108510024017758, 3.6259514539374242, -0.7562993065979746, 0.03935009241104126, 0.03935009241104126],
        [-1.979525540786877, -1.7568802659049967, 1.7494914613459918, -1.6939346870251333, 0.1910150717364417, 3.625722295510163, -0.8387378708985116, 0.03934943675994873, 0.03934943675994873],
        DEFAULT_ARM_SPEED
    ),
    MoveToHandoverProgram(
        [-1.5547487497664334, -1.7548655496061893, 1.8098866582403617, -2.195141738907591, 0.19108510024017758, 3.6259514539374242, -0.7562993065979746, 0.03935009241104126, 0.03935009241104126],
        [-1.979525540786877, -1.7568802659049967, 1.7494914613459918, -1.6939346870251333, 0.1910150717364417, 3.625722295510163, -0.8387378708985116, 0.03934943675994873, 0.03934943675994873],
        DEFAULT_ARM_SPEED
    ),
    MoveToHandoverProgram(
        [-1.5547487497664334, -1.7548655496061893, 1.8098866582403617, -2.195141738907591, 0.19108510024017758, 3.6259514539374242, -0.7562993065979746, 0.03935009241104126, 0.03935009241104126],
        [-1.979525540786877, -1.7568802659049967, 1.7494914613459918, -1.6939346870251333, 0.1910150717364417, 3.625722295510163, -0.8387378708985116, 0.03934943675994873, 0.03934943675994873],
        DEFAULT_ARM_SPEED
    ),
    MoveToHandoverProgram(
        [-1.5547487497664334, -1.7548655496061893, 1.8098866582403617, -2.195141738907591, 0.19108510024017758, 3.6259514539374242, -0.7562993065979746, 0.03935009241104126, 0.03935009241104126],
        [-1.979525540786877, -1.7568802659049967, 1.7494914613459918, -1.6939346870251333, 0.1910150717364417, 3.625722295510163, -0.8387378708985116, 0.03934943675994873, 0.03934943675994873],
        DEFAULT_ARM_SPEED
    ),
    MoveToHandoverProgram(
        [-1.5547487497664334, -1.7548655496061893, 1.8098866582403617, -2.195141738907591, 0.19108510024017758, 3.6259514539374242, -0.7562993065979746, 0.03935009241104126, 0.03935009241104126],
        [-1.979525540786877, -1.7568802659049967, 1.7494914613459918, -1.6939346870251333, 0.1910150717364417, 3.625722295510163, -0.8387378708985116, 0.03934943675994873, 0.03934943675994873],
        DEFAULT_ARM_SPEED
    ),
    MoveToHandoverProgram(
        [-1.5547487497664334, -1.7548655496061893, 1.8098866582403617, -2.195141738907591, 0.19108510024017758, 3.6259514539374242, -0.7562993065979746, 0.03935009241104126, 0.03935009241104126],
        [-1.979525540786877, -1.7568802659049967, 1.7494914613459918, -1.6939346870251333, 0.1910150717364417, 3.625722295510163, -0.8387378708985116, 0.03934943675994873, 0.03934943675994873],
        DEFAULT_ARM_SPEED
    ),
    MoveToHandoverProgram(
        [-1.5547487497664334, -1.7548655496061893, 1.8098866582403617, -2.195141738907591, 0.19108510024017758, 3.6259514539374242, -0.7562993065979746, 0.03935009241104126, 0.03935009241104126],
        [-1.979525540786877, -1.7568802659049967, 1.7494914613459918, -1.6939346870251333, 0.1910150717364417, 3.625722295510163, -0.8387378708985116, 0.03934943675994873, 0.03934943675994873],
        DEFAULT_ARM_SPEED
    ),
    MoveToHandoverProgram(
        [-1.5547487497664334, -1.7548655496061893, 1.8098866582403617, -2.195141738907591, 0.19108510024017758, 3.6259514539374242, -0.7562993065979746, 0.03935009241104126, 0.03935009241104126],
        [-1.979525540786877, -1.7568802659049967, 1.7494914613459918, -1.6939346870251333, 0.1910150717364417, 3.625722295510163, -0.8387378708985116, 0.03934943675994873, 0.03934943675994873],
        DEFAULT_ARM_SPEED
    )
]


def move_to_left_tray(move_group, *args, **kwargs):
    global left_tray_handovers, left_tray_index

    program = left_tray_handovers[left_tray_index]

    # move to close to handover location
    move_to_pose(move_group, program.target_1[0], program.target_1[1], program.target_1[2], program.target_1[3], program.target_1[4], program.target_1[5], program.target_1[6], None, None, program.speed)
    notify_arm_location("handover_location")

    # move to specific handover location
    move_to_pose(move_group, program.target_2[0], program.target_2[1], program.target_2[2], program.target_2[3], program.target_2[4], program.target_2[5], program.target_2[6])
    left_tray_index += 1


def move_to_right_tray(move_group, *args, **kwargs):
    global right_tray_handovers, right_tray_index

    program = right_tray_handovers[right_tray_index]

    # move to close to handover location
    move_to_pose(move_group, program.target_1[0], program.target_1[1], program.target_1[2], program.target_1[3], program.target_1[4], program.target_1[5], program.target_1[6], None, None, program.speed)
    notify_arm_location("handover_location")

    # move to specific handover location
    move_to_pose(move_group, program.target_2[0], program.target_2[1], program.target_2[2], program.target_2[3], program.target_2[4], program.target_2[5], program.target_2[6])
    right_tray_index += 1


def move_to_packaging(move_group, *args, **kwargs):
    global packaging_containers, current_container_index, number_of_items_in_container
    # move to packaging common
    move_to_pose(move_group, 0.5817468816737505, -1.706521653995179, 1.7520496511799224, -2.3061350115391246, 0.1577046152485714, 2.8383838765753637, -0.7505379780597156, 0.015098736621439457, 0.015098736621439457)
    notify_arm_location("packaging")

    # move to specific container and rotate
    cp = packaging_containers[current_container_index]
    move_to_pose(move_group, cp.container_pose[0], cp.container_pose[1], cp.container_pose[2], cp.container_pose[3], cp.container_pose[4], cp.container_pose[5], cp.container_pose[6], None, None, 0.3)
    move_to_pose(move_group, cp.rotation_pose[0], cp.rotation_pose[1], cp.rotation_pose[2], cp.rotation_pose[3], cp.rotation_pose[4], cp.rotation_pose[5], cp.rotation_pose[6], None, None, 0.5)
    move_to_pose(move_group, cp.container_pose[0], cp.container_pose[1], cp.container_pose[2], cp.container_pose[3], cp.container_pose[4], cp.container_pose[5], cp.container_pose[6], None, None, 0.5)

    number_of_items_in_container += 1
    print("Current Container:", current_container_index, "--", "Number of Items:", number_of_items_in_container)
    if number_of_items_in_container == 8:
        current_container_index += 1
        number_of_items_in_container = 0

    if current_container_index >= len(packaging_containers):
        notify_handover_finished()
    
    # move to packaging common
    move_to_pose(move_group, 0.5817468816737505, -1.706521653995179, 1.7520496511799224, -2.3061350115391246, 0.1577046152485714, 2.8383838765753637, -0.7505379780597156, 0.015098736621439457, 0.015098736621439457)


def move_to_idle(move_group, *args, **kwargs):
    move_to_pose(move_group, 0.06557577479094788, -1.6753117668339241, 1.7382581317488122, -2.860015985990825, 0.29034876888328126, 2.8374400304023855, -0.9013231238192982, 0.015098736621439457, 0.015098736621439457)
    notify_arm_location("idle")


def prepare_experiment(move_group, home_gripper_client, grasp_client) -> None:
    home_gripper(home_gripper_client)
    move_to_home(move_group)
    move_to_idle(move_group)
    grasp(grasp_client, 0.035)
    print("Press ENTER to grasp bowl ...")
    input()
    grasp(grasp_client, 0.03)
    print("Press ENTER to continue ...")
    input()


def end_experiment(move_group, home_gripper_client, grasp_client) -> None:
    move_to_idle(move_group)
    print("Press ENTER to release bowl ...")
    input()
    grasp(grasp_client, 0.035)
    print("Press ENTER to when you removed the bowl ...")
    input()
    move_to_home(move_group)
    home_gripper(home_gripper_client)


PROGRAMS: Dict[str, Callable] = {
    "move_to_left_tray": move_to_left_tray,
    "move_to_right_tray": move_to_right_tray,
    "move_to_packaging": move_to_packaging,
    "move_to_idle": move_to_idle,
    "prepare_experiment": prepare_experiment,
    "end_experiment": end_experiment,
}